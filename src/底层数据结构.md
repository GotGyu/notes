## 堆，栈

### 栈

- 栈内存从**高位地址向下增长**，且栈内存是**连续分配**的
- Rust 中，`main` 线程的栈大小是 `8MB`，普通线程是 `2MB`
- 函数调用时会在其中创建一个临时栈空间，调用结束后 Rust 会让这个栈空间里的对象自动进入 `Drop` 流程，最后栈顶指针自动移动到上一个调用栈顶，无需程序员手动干预，因而栈内存申请和释放是**非常高效**的
- 栈更高效是因为操作系统会在底层对栈提供支持，分配专门的寄存器存放站的地址
- 栈上数据转移所有权时，实际是把数据拷贝了一份，**所有权未转移**，变量有两份

### 堆

- 堆内存从**低位地址向上增长**，**堆内存通常只受物理内存限制**，而且通常是**不连续**的
- 获取堆的内容需要两次访问，第一次访问指针，第二次根据指针访问内存
- 堆上数据转移所有权时，是复制一份栈中的指针，再将新的指针赋予新的变量，然后让拥有旧指针的变量失效

### 性能

- 小型数据，在栈上的分配性能和读取性能都要比堆上高
- 中型数据，栈上分配性能高，但是读取性能和堆上并无区别，因为无法利用寄存器或 CPU 高速缓存，最终还是要经过一次内存寻址
- 大型数据，只建议在堆上分配和使用

## Box

将一个值分配到堆上，然后在栈上保留一个智能指针指向堆上的数据